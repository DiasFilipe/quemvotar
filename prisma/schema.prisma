generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  CANDIDATE
  ADMIN
  MODERATOR
}

enum ConsentType {
  POLITICAL_OPINION
}

enum ConsentAction {
  ACCEPT
  REVOKE
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum Office {
  PRESIDENTE
  GOVERNADOR
  SENADOR
  DEPUTADO_FEDERAL
  DEPUTADO_ESTADUAL
  DEPUTADO_DISTRITAL
}

model User {
  id                     String        @id @default(uuid())
  email                  String        @unique
  passwordHash           String
  role                   Role          @default(USER)
  uf                     String?
  cidade                 String?
  zona                   String?
  ideologiaAutoDeclarada String?
  pesosTemas             Json?
  consentAcceptedAt      DateTime?
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  sessions               Session[]
  consents               Consent[]
  consentLogs            ConsentLog[]
  userAnswers            UserAnswer[]
  scores                 Score[]
  candidates             Candidate[]   @relation("UserCandidates")
  moderationLogs         ModerationLog[] @relation("AdminModeration")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  revokedAt DateTime?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Consent {
  id         String      @id @default(uuid())
  userId     String
  type       ConsentType
  acceptedAt DateTime
  revokedAt  DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId, type])
}

model ConsentLog {
  id        String        @id @default(uuid())
  userId    String
  type      ConsentType
  action    ConsentAction
  ip        String?
  userAgent String?
  createdAt DateTime      @default(now())

  user      User          @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([userId, type])
}

model Question {
  id        String   @id
  theme     String
  text      String
  sortOrder Int

  answers   UserAnswer[]
}

model UserAnswer {
  id         String   @id @default(uuid())
  userId     String
  questionId String
  value      Int
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId])
  @@index([questionId])
}

model Candidate {
  id                 String             @id @default(uuid())
  userId             String?
  nomeUrna           String
  nomeCompleto       String?
  partido            String?
  cargo              Office
  uf                 String?
  numero             String?
  zona               String?
  statusVerificacao  VerificationStatus @default(PENDING)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user               User?              @relation("UserCandidates", fields: [userId], references: [id], onDelete: SetNull)
  profile            CandidateProfile?
  answers            CandidateAnswer[]
  adminScores        AdminScore[]
  verification       Verification?
  scores             Score[]
  moderationLogs     ModerationLog[]

  @@index([cargo, uf])
  @@index([statusVerificacao])
}

model CandidateProfile {
  id          String   @id @default(uuid())
  candidateId String   @unique
  bio         String?
  causas      Json?
  links       Json?
  updatedAt   DateTime @updatedAt

  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
}

model CandidateAnswer {
  id          String   @id @default(uuid())
  candidateId String
  theme       String
  value       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@unique([candidateId, theme])
}

model AdminScore {
  id          String   @id @default(uuid())
  candidateId String
  theme       String
  value       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@unique([candidateId, theme])
}

model Verification {
  id          String             @id @default(uuid())
  candidateId String             @unique
  status      VerificationStatus @default(PENDING)
  docHash     String?
  selfieHash  String?
  verifiedAt  DateTime?
  createdAt   DateTime           @default(now())

  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
}

model Score {
  id          String   @id @default(uuid())
  userId      String
  candidateId String
  score       Int
  motivos     Json?
  generatedAt DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([candidateId])
}

model ModerationLog {
  id          String   @id @default(uuid())
  candidateId String
  action      String
  reason      String?
  adminId     String?
  createdAt   DateTime @default(now())

  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Restrict)
  admin       User?     @relation("AdminModeration", fields: [adminId], references: [id], onDelete: SetNull)

  @@index([candidateId])
  @@index([adminId])
}
